# faircentroid
Code and data for the paper "Towards Fairer Centroids in $k$-means Clustering"
under review at ECAI 2023 (Paper #1604).

## File structure
1. [data](data): contains datasets and generated data
2. [src](src): contains source code
3. [.](.): contains python scripts, notebooks, and other files

## Getting started
To run code in this repository, you will need [Anaconda](https://www.anaconda.com/)
or [miniconda](https://docs.conda.io/en/latest/miniconda.html). Next, create
a conda environment from the [environment.yaml](environment.yaml) file:
```bash
conda env create -f environment.yaml
```
Activate the conda environment:
```bash
conda activate faircentroid
```

## Datasets (see &sect; 6.1.1 in the paper)
The datasets used for evaluation are based on the publicly available
Adult[^adult] and CreditCard[^creditcard] datasets from the UCI repository. In
case of Adult, we use `sex` and `race` as sensitive attributes. In case of
CreditCard, we use `SEX` as the sensitive attribute. These datasets are loaded
as:

1. Adult/`sex`:

   ```python
   from src.datasets import adult
   dataset = adult.load(yamlpath=adult.SEX)
   ```

2. Adult/`race`:
   ```python
   from src.datasets import adult
   dataset = adult.load(yamlpath=adult.RACE)
   ```

3. CreditCard/`SEX`:

   ```python
   from src.datasets import creditcard
   dataset = creditcard.load(yamlpath=creditcard.SEX)
   ```

`dataset` is a dictionary containing the following keys
1. `name`: name of the dataset
2. `sensitive_groups`: list of sensitive groups
3. `X`: objects in the dataset
4. `s`: sensitive groups to which the objects belong

See the [`src.datasets`](src/datasets) package for implementations.

## Initial centroids
Initial centroids for the $k$-means algorithms can be generated using
$k$-means++[^Arthur2007K] as:
```python
from src.init import kmeans_plusplus
init_centroids = kmeans_plusplus(X=X, n_clusters=n_clusters, random_state=random_state)
```
where `n_clusters` is the number of clusters to form and `random_state` is the
random seed for initialising the centroids.

## Algorithms (see &sect; 6.1.2 in the paper)
Implementations for 3 algorithms for $k$-means are available: the baselines
Lloyd's heuristic[^MacQueen1967Some] and Fair-Lloyd[^Ghadiri2021Socially] with
gradient descent, and the newly proposed algorithm Fair-Centroid. These
algorithms are run as:

1. Lloyd:

   ```python
   from src.algorithms import lloyd
   c, centroids = lloyd.run(n_clusters=n_clusters, X=X, init_centroids=init_centroids)
   ```

2. Fair-Lloyd:

   ```python
   from src.algorithms import fairlloyd_gd
   c, centroids = fairlloyd_gd.run(n_clusters=n_clusters, X=X, s=s, init_centroids=init_centroids)
   ```

3. Fair-Centroid:

   ```python
   from src.algorithms import faircentroid
   c, centroids = faircentroid.run(n_clusters=n_clusters, X=X, s=s, init_centroids=init_centroids, sensitive_groups=sensitive_groups, lambda_=lambda_)
   ```

where `c` is the cluster assignment generated by the algorithm, `centroids` is
the set of centroids generated by the algorithm, and `lambda_` is the
hyperparameter that controls the trade-off between utility and fairness in
Fair-Centroid.

For working examples of the 3 algorithms, refer to [lloyd.ipynb](lloyd.ipynb),
[fairlloyd_gd.ipynb](fairlloyd_gd.ipynb), and
[faircentroid.ipynb](faircentroid.ipynb).

See the [`src.algorithms`](src/algorithms) package for implementations.

## Reproducing results (see &sect; 6.2 in the paper)
The following lines of code illustrate how the results in the paper were
produced.

### Preparation
1. Generate configurations for initialising centroids ([init_configs_generator.py](init_configs_generator.py)):

   ```bash
   python init_configs_generator.py adult data/datasets/Adult_sex/adult.yaml --min_clusters 3 --max_clusters 12 --n_random_states 100 --init_method kmeans_plusplus
   python init_configs_generator.py adult data/datasets/Adult_race/adult.yaml --min_clusters 3 --max_clusters 12 --n_random_states 100 --init_method kmeans_plusplus
   python init_configs_generator.py creditcard data/datasets/CreditCard_SEX/creditcard.yaml --min_clusters 3 --max_clusters 12 --n_random_states 100 --init_method kmeans_plusplus
   ```
   The configurations will be generated in the directory specified in
   [`CONFIG_DIR`](src/init.py#L17) in [`src.init`](src/init.py).

2. Initialise centroids ([init_generator.py](init_generator.py)):

   ```bash
   python init_generator.py Adult_sex
   python init_generator.py Adult_race
   python init_generator.py CreditCard_SEX
   ```
   The centroids will be generated in the directory specified in
   [`SAVE_DIR`](src/init.py#L19) in [`src.init`](src/init.py).

3. Generate experiment configurations ([expt_configs_generator.py](expt_configs_generator.py)):

   1. for different $k$ with $\lambda$=0.5:

      ```bash
      python expt_configs_generator.py adult data/datasets/Adult_sex/adult.yaml --lambdas 0.5
      python expt_configs_generator.py adult data/datasets/Adult_race/adult.yaml --lambdas 0.5
      python expt_configs_generator.py creditcard data/datasets/CreditCard_SEX/creditcard.yaml --lambdas 0.5
      ```

   2. for different $\lambda$ with fixed $k$:
      
      Using the elbow method; $k$=5 for the Adult datasets, and $k$=4 for the
      CreditCard dataset.
      ```bash
      python expt_configs_generator.py adult data/datasets/Adult_sex/adult.yaml --n_clusters 5 --lambdas 0.1 0.2 0.3 0.4 0.6 0.7 0.8 0.9 1.0
      python expt_configs_generator.py adult data/datasets/Adult_race/adult.yaml --n_clusters 5 --lambdas 0.1 0.2 0.3 0.4 0.6 0.7 0.8 0.9 1.0
      python expt_configs_generator.py creditcard data/datasets/CreditCard_SEX/creditcard.yaml --n_clusters 4 --lambdas 0.1 0.2 0.3 0.4 0.6 0.7 0.8 0.9 1.0
      ```

   The configurations will be generated in the directory specified in
   [`CONFIG_DIR`](src/experiments.py#L16) in
   [`src.experiments`](src/experiments.py).

### Generating clusters and centroids
1. For the 3 algorithms with different $k$ ([n_clusters_expt.py](n_clusters_expt.py)):

   ```bash
   python n_clusters_expt.py Adult_sex 0 --init_method kmeans_plusplus --lambda_ 0.5
   python n_clusters_expt.py Adult_sex 1 --init_method kmeans_plusplus --lambda_ 0.5
   :
   python n_clusters_expt.py Adult_race 0 --init_method kmeans_plusplus --lambda_ 0.5
   python n_clusters_expt.py Adult_race 1 --init_method kmeans_plusplus --lambda_ 0.5
   :
   python n_clusters_expt.py CreditCard_SEX 0 --init_method kmeans_plusplus --lambda_ 0.5
   python n_clusters_expt.py CreditCard_SEX 1 --init_method kmeans_plusplus --lambda_ 0.5
   :
   ```

2. For the Fair-Centroid algorithm with different $\lambda$ ([lambda_expt.py](lambda_expt.py)):

   ```bash
   python lambda_expt.py Adult_sex 0 --init_method kmeans_plusplus --n_clusters 5
   python lambda_expt.py Adult_sex 1 --init_method kmeans_plusplus --n_clusters 5
   :
   python lambda_expt.py Adult_race 0 --init_method kmeans_plusplus --n_clusters 5
   python lambda_expt.py Adult_race 1 --init_method kmeans_plusplus --n_clusters 5
   :
   python lambda_expt.py CreditCard_SEX 0 --init_method kmeans_plusplus --n_clusters 4
   python lambda_expt.py CreditCard_SEX 1 --init_method kmeans_plusplus --n_clusters 4
   :
   ```

The clusters and centroids will be generated in the directory specified in
[`SAVE_DIR`](src/experiments.py#L18) in [`src.experiments`](src/experiments.py).

### Evaluation
1. For the effect of $k$ ([n_clusters_eval.py](n_clusters_eval.py)):

   ```bash
   python n_clusters_eval.py adult data/datasets/Adult_sex/adult.yaml --init_method kmeans_plusplus --lambda_ 0.5
   python n_clusters_eval.py adult data/datasets/Adult_race/adult.yaml --init_method kmeans_plusplus --lambda_ 0.5
   python n_clusters_eval.py creditcard data/datasets/CreditCard_SEX/creditcard.yaml --init_method kmeans_plusplus --lambda_ 0.5
   ```

2. For the effect of $\lambda$ ([lambda_eval.py](lambda_eval.py)):

   ```bash
   python lambda_eval.py adult data/datasets/Adult_sex/adult.yaml --init_method kmeans_plusplus --n_clusters 5
   python lambda_eval.py adult data/datasets/Adult_race/adult.yaml --init_method kmeans_plusplus --n_clusters 5
   python lambda_eval.py creditcard data/datasets/CreditCard_SEX/creditcard.yaml --init_method kmeans_plusplus --n_clusters 4
   ```

The evaluated scores will be saved in the '<dataset_name>/analysis' subdirectory
within the directory specified in  [`SAVE_DIR`](src/experiments.py#L18) in
[`src.experiments`](src/experiments.py).

### Generating plots
1. For the effect of $k$ ([n_clusters_plot.py](n_clusters_plot.py)):

   ```bash
   python n_clusters_plot.py Adult_sex --init_method kmeans_plusplus
   python n_clusters_plot.py Adult_race --init_method kmeans_plusplus
   python n_clusters_plot.py CreditCard_SEX --init_method kmeans_plusplus
   ```

   The following plots were generated by our results:
   1. Fairness vs Utility (see &sect; 6.2.1 in the paper):
      
      | Average cluster disparity | Figure 4 | [Adult/`sex`](data/expts/Adult_sex/analysis/n_clusters%20vs%20average%20cluster%20disparity%20-%20Adult_sex.pdf) | [Adult/`race`](data/expts/Adult_race/analysis/n_clusters%20vs%20average%20cluster%20disparity%20-%20Adult_race.pdf) | [CreditCard/`SEX`](data/expts/CreditCard_SEX/analysis/n_clusters%20vs%20average%20cluster%20disparity%20-%20CreditCard_SEX.pdf) |
      | ---- | ---- | ---- | ---- | ---- |

      | $k$-means objective | Figure 5 | [Adult/`sex`](data/expts/Adult_sex/analysis/n_clusters%20vs%20k-means%20objective%20-%20Adult_sex.pdf) | [Adult/`race`](data/expts/Adult_race/analysis/n_clusters%20vs%20k-means%20objective%20-%20Adult_race.pdf) | [CreditCard/`SEX`](data/expts/CreditCard_SEX/analysis/n_clusters%20vs%20k-means%20objective%20-%20CreditCard_SEX.pdf) |
      | ---- | ---- | ---- | ---- | ---- |

   2. Fair Centroid Objective vs Fair $k$-means (see &sect; 6.2.2 in the paper):

      | Fair centroid objective | Figure 6 | [Adult/`sex`](data/expts/Adult_sex/analysis/n_clusters%20vs%20fair%20centroid%20objective%20-%20Adult_sex.pdf) | [Adult/`race`](data/expts/Adult_race/analysis/n_clusters%20vs%20fair%20centroid%20objective%20-%20Adult_race.pdf) | [CreditCard/`SEX`](data/expts/CreditCard_SEX/analysis/n_clusters%20vs%20fair%20centroid%20objective%20-%20CreditCard_SEX.pdf) |
      | ---- | ---- | ---- | ---- | ---- |

      | Fair $k$-means objective | Figure 7 | [Adult/`sex`](data/expts/Adult_sex/analysis/n_clusters%20vs%20fair%20k-means%20objective%20-%20Adult_sex.pdf) | [Adult/`race`](data/expts/Adult_race/analysis/n_clusters%20vs%20fair%20k-means%20objective%20-%20Adult_race.pdf) | [CreditCard/`SEX`](data/expts/CreditCard_SEX/analysis/n_clusters%20vs%20fair%20k-means%20objective%20-%20CreditCard_SEX.pdf) |
      | ---- | ---- | ---- | ---- | ---- |

2. For the effect of $\lambda$ ([lambda_plot.py](lambda_plot.py)):

   ```bash
   python lambda_plot.py Adult_sex --init_method kmeans_plusplus
   python lambda_plot.py Adult_race --init_method kmeans_plusplus
   python lambda_plot.py CreditCard_SEX --init_method kmeans_plusplus
   ```

   The following plots were generated by our results (see &sect; 6.2.3 in the paper):

   | Average cluster disparity | Figure 8 | [Adult/`sex`](data/expts/Adult_sex/analysis/lambda_%20vs%20average%20cluster%20disparity%20-%20Adult_sex.pdf) | [Adult/`race`](data/expts/Adult_race/analysis/lambda_%20vs%20average%20cluster%20disparity%20-%20Adult_race.pdf) | [CreditCard/`SEX`](data/expts/CreditCard_SEX/analysis/lambda_%20vs%20average%20cluster%20disparity%20-%20CreditCard_SEX.pdf) |
   | ---- | ---- | ---- | ---- | ---- |

   | $k$-means objective | Figure 9 | [Adult/`sex`](data/expts/Adult_sex/analysis/lambda_%20vs%20k-means%20objective%20-%20Adult_sex.pdf) | [Adult/`race`](data/expts/Adult_race/analysis/lambda_%20vs%20k-means%20objective%20-%20Adult_race.pdf) | [CreditCard/`SEX`](data/expts/CreditCard_SEX/analysis/lambda_%20vs%20k-means%20objective%20-%20CreditCard_SEX.pdf) |
   | ---- | ---- | ---- | ---- | ---- |

3. For the disparity trends ([faircentroid_plot.py](faircentroid_plot.py)):

   ```bash
   python faircentroid_plot.py --dataset_name Adult_race --n_clusters 3 --init_method kmeans_plusplus --random_state 46 --lambda_ 0.5
   ```
   The following plot was generated by our results (see &sect; 6.2.4, Figure 10
   in the paper): [Adult_race.k3.r46.pdf](data/expts/Adult_race/analysis/Adult_race.k3.r46.pdf).

The generated plots will be saved in the '<dataset_name>/analysis' subdirectory
within the directory specified in  [`SAVE_DIR`](src/experiments.py#L18) in
[`src.experiments`](src/experiments.py).

## Toy examples (see &sect; 1 in the paper)
The generated toy examples are saved in [data/toy](data/toy). For generation of
the toy examples in the paper, refer to
[Toy Example 1.ipynb](Toy%20Example%201.ipynb) for Figure 1,
[Toy Example 2.ipynb](Toy%20Example%202.ipynb) for Figure 2, and
[Toy Example 3.ipynb](Toy%20Example%203.ipynb) for Figure 3.

## Cite
If you use the Adult or CreditCard datasets, please consider citing the following
(taken from the
[UCI Machine Learning Repository's citation policy](https://archive.ics.uci.edu/ml/citation_policy.html)):
```bibtex
@misc{Dua2019UCI,
    author      = {Dua, Dheeru and
                   Graff, Casey},
    title       = {{UCI Machine Learning Repository}},
    year        = {2019},
    institution = {University of California, Irvine, School of Information and Computer Sciences},
    url         = {http://archive.ics.uci.edu/ml},
    }
```

If you use the Fair-Lloyd algorithm, please cite the following:
```bibtex
@inproceedings{Ghadiri2021Socially,
    author    = {Ghadiri, Mehrdad and
                 Samadi, Samira and
                 Vempala, Santosh},
    title     = {{Socially Fair $k$-Means Clustering}},
    booktitle = {Proceedings of the 2021 ACM Conference on Fairness, Accountability, and Transparency (FAccT '21)},
    volume    = {},
    series    = {},
    year      = {2021},
    publisher = {ACM},
    pages     = {438--448},
    doi       = {10.1145/3442188.3445906},
    }
```

[^adult]: https://archive.ics.uci.edu/ml/datasets/adult
[^creditcard]: https://archive.ics.uci.edu/ml/datasets/default+of+credit+card+clients
[^MacQueen1967Some]: James MacQueen, 'Some Methods for Classification and Analysis of Multivariate Observations', in _Proceedings of the Fifth Berkeley Symposium on Mathematical Statistics and Probability_, volume 1, pp. 281–297, (1967).
[^Ghadiri2021Socially]: Mehrdad Ghadiri, Samira Samadi, and Santosh Vempala, 'Socially Fair k-Means Clustering', in _Proceedings of the 2021 ACM Conference on Fairness, Accountability, and Transparency (FAccT ’21)_, pp. 438–448. ACM, (2021).
[^Arthur2007K]: David Arthur and Sergei Vassilvitskii, 'K-Means++: The Advantages of Careful Seeding', in _Proceedings of the Eighteenth Annual ACM-SIAM Symposium on Discrete Algorithms (SODA ’07)_, pp. 1027–1035. SIAM, (2007).
